name: "Deploy Static"
description: "Deploys frontend app to aws S3"
inputs:
  s3-bucket:
    description: "S3 bucket where for hosting site"
    required: true
  distribution-id:
    description: "Cloudfront distribution id"
    required: true
  aws-access-key-id:
    description: "Aws access key id"
    required: true
  aws-secret-access-key:
    description: "Aws secret access key"
    required: true
  build-dir:
    description: "Directory where the app is build"
    required: true
  env-file-content:
    description: "Contents of env file usually stored in github secrets"
    required: false

runs:
  using: "composite"
  steps:
		- name: Write .env file if provided
      if: inputs.env-file-content != ''
      run: |
        echo "${{ inputs.env-file-content }}" > .env
      shell: bash

    # Runs a packages install
    - name: Running package install
      run: yarn
      shell: bash

    # Builds the app if requested
    - name: Build the app if requested
      run: yarn build
      shell: bash

    # Upload the site
    - name: Sync files from build folder to s3
      env:
        AWS_ACCESS_KEY_ID: ${{ inputs.aws-access-key-id }}
        AWS_ACCESS_SECRET_KEY: ${{ inputs.aws-access-secret-key }}
      run: aws s3 sync ${{ inputs.build-dir }} ${{ inputs.s3-bucket }} --delete
      shell: bash

    # Invalidate cloudfront cache
    - name: Invalidate CloudFront Cache
      env:
        AWS_ACCESS_KEY_ID: ${{ inputs.aws-access-key-id }}
        AWS_ACCESS_SECRET_KEY: ${{ inputs.aws-access-secret-key }}
      run: aws cloudfront create-invalidation --distribution-id ${{ inputs.distribution-id }} --paths "/*"
      shell: bash
